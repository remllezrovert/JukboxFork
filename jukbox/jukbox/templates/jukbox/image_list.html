<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image and File Upload</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.css">
    <style>
        .columns {
            display: flex;
            gap: 10px;
        }
        .image-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 100px;
            border: 1px dashed #ccc;
            padding: 10px;
        }
        .image-item, .file-item {
            border: 1px solid #ccc;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: move;
        }

        .image-item img {
            max-width: 100%;
            height: auto;
        }

        .delete-button {
            margin-top: 5px;
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        .iframe-container {
            display: none;
            margin-top: 20px;
        }

        .toggle-button {
            cursor: pointer;
            color: black;
            width: 20%;
            height: 15%;
        }

        #recButton {
            width: 50px;
            height: 50px;
            font-size: 0;
            border: 0;
            border-radius: 50%;
            margin: 18px;
            outline: none;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .notRec {
            background-color: #800000;
        }

        .Rec {
            background-color: #ff0000;
            animation-name: pulse;
            animation-duration: 1.5s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        #timer {
            font-size: 24px;
            margin-top: 20px;
            color: black;
            font-weight: bold;
        }
    </style>
</head>
<body>

<p>Click the button to start/stop recording</p>

<form id="fileNameForm" method="POST">
    {% csrf_token %}
    <input type="text" id="fileName" name="fileName" placeholder="Enter file name" required />
    <button type="button" id="recButton" class="notRec"></button>
</form>

<div id="timer">00:00:00</div>

<h1>Upload and View Geophone Data</h1>
<button type="button" class="toggle-button" onclick="toggleIframe()">Toggle Map</button>
<div class="iframe-container" id="iframeContainer">
    <iframe width="90%" height="500" src="https://stationview.raspberryshake.org" style="display: flex;"></iframe>
</div>

<button type="button" class="toggle-button" onclick="toggleFiles()">Toggle Files</button>

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="files" multiple required id="file">
    <button type="submit">Upload</button>
</form>

<div class="file-container" id="file-container" style="display: none;">
    {% for file in files %}
        <div class="file-item">
            <span>{{ file }}</span>
            <form action="" method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="process" value="{{ file }}">
                <button type="submit" class="process-button">Process</button>
            </form>
            <form action="" method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="delete" value="{{ file }}">
                <button type="submit" class="delete-button">Delete</button>
            </form>
        </div>
    {% empty %}
        <p>No files uploaded yet.</p>
    {% endfor %}
</div>

<!-- Two Column Image Layout -->
<div class="columns" id="imageContainer">
    <div class="image-column" id="column1">
        {% for image in images %}
            {% if forloop.counter0|divisibleby:2 %}
                <div class="image-item">
                    <img src="media/images/{{ image }}" alt="Uploaded Image">
                    <form action="" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="delete" value="{{ image }}">
                        <button type="submit" class="delete-button">Delete</button>
                    </form>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <div class="image-column" id="column2">
        {% for image in images %}
            {% if not forloop.counter0|divisibleby:2 %}
                <div class="image-item">
                    <img src="media/images/{{ image }}" alt="Uploaded Image">
                    <form action="" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="delete" value="{{ image }}">
                        <button type="submit" class="delete-button">Delete</button>
                    </form>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>
<script>
    let timerInterval;
    let totalSeconds = 0;

    function formatTime(seconds) {
        const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
        const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        return `${hours}:${minutes}:${secs}`;
    }

    $(document).ready(function() {
        dragula([document.getElementById('column1'), document.getElementById('column2')]);

        $('#recButton').click(function() {
            const isRecording = $(this).hasClass('Rec');
            const fileName = $('#fileName').val();

            if (!isRecording) {
                $(this).removeClass('notRec').addClass('Rec');
                console.log('Recording started');

                $.ajax({
                    type: 'POST',
                    url: '{% url "record-view" %}',
                    data: {
                        'fileName': fileName,
                        'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
                    },
                    success: function(response) {
                        console.log(response.message);
                        startTimer();
                    },
                    error: function() {
                        alert('Error starting recording');
                    }
                });

            } else {
                $(this).removeClass('Rec').addClass('notRec');
                console.log('Recording stopped');
                stopTimer();
            }
        });
    });

    function startTimer() {
        timerInterval = setInterval(function() {
            totalSeconds++;
            $('#timer').text(formatTime(totalSeconds));
            if (totalSeconds >= 86400) {
                stopTimer();
                alert('Timer reached 24 hours');
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
        totalSeconds = 0;
        $('#timer').text(formatTime(totalSeconds));
    }

    function toggleIframe() {
        const iframeContainer = document.getElementById('iframeContainer');
        iframeContainer.style.display = iframeContainer.style.display === 'none' ? 'block' : 'none';
    }

    function toggleFiles() {
        const fileContainer = document.getElementById('file-container');
        fileContainer.style.display = fileContainer.style.display === 'none' ? 'block' : 'none';
    }
</script>
</body>
</html>
